<!-- TODO
 Move colors: (From extract theme tab) to the pbr page, under the color palette.
  Remove extract theme tab (Without breaking in the pbr page).
  Remove pixalate tab (Without breaking in the pbr page).
  Remove image to mesh (Without breaking in the pbr page).
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creative Toolbox</title>
    <link rel="icon" type="image/png" href="Icons/artist_toolbox_icon.png">
    <link rel="stylesheet" href="styles.css">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/fflate@0.7.4/umd/index.min.js"></script>
    <!-- Three.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/exporters/GLTFExporter.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/RGBELoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/FBXLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
</head>
<body>
    <script type="module" src="app.js"></script>

    <!-- Top Application Header -->
    <div class="app-header">
        <div class="relative">
            <button id="appLauncherBtn" class="header-button">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                </svg>
                <span>Tools</span>
            </button>
            <div id="tabSelectionDropdown" class="absolute top-full left-0 mt-2 w-max bg-white rounded-md shadow-lg p-2 z-10 hidden" style="min-width: 150px;">
                <div class="tab-buttons">
                    <button class="tab-button" data-tab-id="texture-pbr-tab">PBR</button>
                    <button class="tab-button" data-tab-id="animation-combiner-tab">Animate</button>
                    <button class="tab-button" data-tab-id="image-to-mesh-tab">Image to Mesh</button>
                    <button class="tab-button" data-tab-id="image-to-envmap-tab">Image to EnvMap</button>
                </div>
            </div>
        </div>
        <h3 class="text-sm font-semibold text-gray-700 app-title">Creative Toolbox</h3>
        <div class="flex items-center gap-2">
            <!-- New: Donation Goal Progress Bar moved here -->
            <div id="donationGoalSection" class="flex flex-col items-start px-2 py-1 bg-gray-50 rounded-lg border border-gray-200">
                <div class="flex items-center gap-1 text-xs">
                    <span class="font-semibold text-gray-700">Goal:</span>
                    <span id="incomeText" class="income-text">$0 / $100</span>
                    <span id="percentageText" class="percentage-text ml-auto">0%</span>
                </div>
                <div class="income-progress-container w-full">
                    <div id="incomeProgressBar" class="income-progress-bar"></div>
                </div>
            </div>
            <!-- End Donation Goal Progress Bar -->

            <!-- New: Patreon Support Button -->
            <a href="https://www.patreon.com/YOUR_PATREON_PROFILE" target="_blank" rel="noopener noreferrer" class="header-button">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-heart"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>
                <span>Support</span>
            </a>

            <div class="relative">
                <button id="exportButtonHeader" class="header-button">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9.75v6.75m0 0l-3-3m3 3l3-3m-8.25 6h12.75" />
                    </svg>
                    <span>Export</span>
                </button>
                <div id="exportOptionsDropdown" class="absolute top-full right-0 mt-2 w-72 bg-white rounded-md shadow-lg p-4 z-10 hidden">
                    <div class="controls-group" style="border-top: none; margin-top: 0; padding-top: 0;">
                        <label for="exportResolution" class="text-xs font-medium">
                            <span>Resolution:</span>
                        </label>
                        <select id="exportResolution">
                            <option value="original" selected>Original Size</option>
                            <option value="24">24x24</option>
                            <option value="48">48x48</option>
                            <option value="64">64x64</option>
                            <option value="128">128x128</option>
                            <option value="256">256x256</option>
                            <option value="512">512x512</option>
                            <option value="1024">1024x1024</option>
                        </select>
                        <div class="flex flex-col gap-2 mt-4">
                            <p class="text-sm font-medium text-gray-700">Select Maps to Export:</p>
                            <div class="flex items-center gap-1">
                                <input type="checkbox" id="exportOriginalTextureDropdown" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" checked>
                                <label for="exportOriginalTextureDropdown" class="cursor-pointer select-none text-sm">Color Map (Albedo)</label>
                            </div>
                            <div class="flex items-center gap-1">
                                <input type="checkbox" id="exportNormalMapDropdown" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" checked>
                                <label for="exportNormalMapDropdown" class="cursor-pointer select-none text-sm">Normal Map</label>
                            </div>
                            <div class="flex items-center gap-1">
                                <input type="checkbox" id="exportRoughnessMapDropdown" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" checked>
                                <label for="exportRoughnessMapDropdown" class="cursor-pointer select-none text-sm">Roughness Map</label>
                            </div>
                            <div class="flex items-center gap-1">
                                <input type="checkbox" id="exportAOMapDropdown" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" checked>
                                <label for="exportAOMapDropdown" class="cursor-pointer select-none text-sm">Ambient Occlusion (AO) Map</label>
                            </div>
                            <div class="flex items-center gap-1">
                                <input type="checkbox" id="exportMetallicMapDropdown" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" checked>
                                <label for="exportMetallicMapDropdown" class="cursor-pointer select-none text-sm">Metallic Map</label>
                            </div>
                            <div class="flex items-center gap-1">
                                <input type="checkbox" id="exportDisplacementMapDropdown" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" checked>
                                <label for="exportDisplacementMapDropdown" class="cursor-pointer select-none text-sm">Displacement Map</label>
                            </div>
                            <div class="flex items-center gap-1">
                                <input type="checkbox" id="exportEmissionMapDropdown" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" checked>
                                <label for="exportEmissionMapDropdown" class="cursor-pointer select-none text-sm">Emission Map</label>
                            </div>
                            <!-- Separator and new checkbox for 3D mesh export -->
                            <div class="border-t border-gray-200 my-2"></div>
                            <div class="flex items-center gap-1">
                                <input type="checkbox" id="export3DMeshDropdown" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" checked>
                                <label for="export3DMeshDropdown" class="cursor-pointer select-none text-sm font-semibold">Export 3D Mesh (.glb)</label>
                            </div>
                        </div>
                        <button id="exportButtonDropdown" class="custom-file-upload mt-4">Export Selected Maps</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Wrapper -->
    <div class="main-content-wrapper">
        <div class="container">
            <!-- Left Panel: Controls and 2D Maps -->
            <div class="left-panel">
                <p class="text-center text-sm leading-relaxed mb-3">
                    Your ultimate companion for 2D/3D art workflows.
                </p>

                <!-- Controls for Texture Weaver (PBR) Tab -->
                <div id="texture-pbr-controls" class="controls-group active-controls">
                    <label id="textureDropZone" class="drop-zone">
                        <span class="text-sm text-gray-400 pointer-events-none">Drag & drop image or click to upload</span>
                        <input type="file" id="textureInput" accept="image/*">
                        <span id="fileNameDisplay" class="text-xs text-center break-words w-full mt-2 block">No image selected.</span>
                        <div id="loadingSpinner" class="loader mx-auto"></div>
                    </label>

                    <div class="w-full mt-2">
                        <button id="makeSeamlessButton" class="w-full py-1.5 bg-indigo-700 text-white text-xs rounded hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-indigo-500 transition-colors">Make Texture Seamless</button>
                    </div>

                    <div class="controls-group" id="seamlessControls">
                        <label for="seamlessMethodSelect" class="text-sm font-semibold text-gray-700">Method:</label>
                        <select id="seamlessMethodSelect">
                            <option value="mirror">Mirror (9-Slice)</option>
                            <option value="blend" selected>Blend (Scattered Edges)</option>
                        </select>

                        <div id="seamlessBlendControls" style="display: block;">
                            <div class="slider-group">
                                <label for="seamlessRadiusSlider">Radius: <span id="seamlessRadiusValue">5</span></label>
                                <input type="range" id="seamlessRadiusSlider" min="1" max="20" step="1" value="5">
                            </div>
                            <div class="slider-group mt-2">
                                <label for="seamlessIntensitySlider">Intensity: <span id="seamlessIntensityValue">100</span></label>
                                <input type="range" id="seamlessIntensitySlider" min="0" max="100" step="1" value="100">
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-1 mt-2">
                        <input type="checkbox" id="invertNormalY" class="h-3.5 w-3.5 text-indigo-600 focus:ring-indigo-500 border-gray-500 rounded cursor-pointer bg-gray-700">
                        <label for="invertNormalY" class="cursor-pointer select-none text-xs">Invert Normal Map Y</label>
                    </div>
                    <div class="flex items-center gap-1 mt-1">
                        <input type="checkbox" id="invertMetallic" class="h-3.5 w-3.5 text-indigo-600 focus:ring-indigo-500 border-gray-500 rounded cursor-pointer bg-gray-700">
                        <label for="invertMetallic" class="cursor-pointer select-none text-xs">Invert Metallic Map</label>
                    </div>

                    <!-- 2D Maps Grid for PBR Tab -->
                    <div class="map-grid">
                        <div class="canvas-container" data-map-type="Color Map" data-source-canvas-id="originalTextureCanvas" data-explanation="The base color map (Albedo) that defines the diffuse color of the surface.">
                            <h2 class="text-sm font-semibold text-gray-700">Color</h2>
                            <div class="flex items-center gap-1 mt-1">
                                <input type="checkbox" id="exportOriginalTexture" class="h-3 w-3 text-indigo-600 focus:ring-indigo-500 border-gray-500 rounded bg-gray-700" checked>
                                <label for="exportOriginalTexture" class="text-xs">Export</label>
                            </div>
                            <div class="canvas-wrapper">
                                <canvas id="originalTextureCanvas" width="90" height="90"></canvas>
                            </div>
                        </div>
                        <div class="canvas-container" data-map-type="Normal Map" data-source-canvas-id="normalMapCanvas" data-explanation="Simulates surface detail and bumps without adding more geometry. Encodes direction vectors in RGB.">
                            <h2 class="text-sm font-semibold text-gray-700">Normal</h2>
                            <div class="flex items-center gap-1 mt-1">
                                <input type="checkbox" id="exportNormalMap" class="h-3 w-3 text-indigo-600 focus:ring-indigo-500 border-gray-500 rounded bg-gray-700" checked>
                                <label for="exportNormalMap" class="text-xs">Export</label>
                            </div>
                            <div class="canvas-wrapper">
                                <canvas id="normalMapCanvas" width="90" height="90"></canvas>
                            </div>
                        </div>
                        <div class="canvas-container" data-map-type="Roughness Map" data-source-canvas-id="roughnessMapCanvas" data-explanation="Controls how rough or smooth a surface is. Black (0) is smooth (shiny), White (1) is rough (matte).">
                            <h2 class="text-sm font-semibold text-gray-700">Roughness</h2>
                            <div class="flex items-center gap-1 mt-1">
                                <input type="checkbox" id="exportRoughnessMap" class="h-3 w-3 text-indigo-600 focus:ring-indigo-500 border-gray-500 rounded bg-gray-700" checked>
                                <label for="exportRoughnessMap" class="text-xs">Export</label>
                            </div>
                            <div class="canvas-wrapper">
                                <canvas id="roughnessMapCanvas" width="90" height="90"></canvas>
                            </div>
                        </div>
                        <div class="canvas-container" data-map-type="Ambient Occlusion Map" data-source-canvas-id="aoMapCanvas" data-explanation="Simulates contact shadows in crevices and corners, adding depth. White means fully lit, Black means fully occluded.">
                            <h2 class="text-sm font-semibold text-gray-700">AO</h2>
                            <div class="flex items-center gap-1 mt-1">
                                <input type="checkbox" id="exportAOMap" class="h-3 w-3 text-indigo-600 focus:ring-indigo-500 border-gray-500 rounded bg-gray-700" checked>
                                <label for="exportAOMap" class="text-xs">Export</label>
                            </div>
                            <div class="canvas-wrapper">
                                <canvas id="aoMapCanvas" width="90" height="90"></canvas>
                            </div>
                        </div>
                        <div class="canvas-container" data-map-type="Metallic Map" data-source-canvas-id="metallicMapCanvas" data-explanation="Defines which parts of the surface are metallic. White (1) is metallic, Black (0) is non-metallic (dielectric).">
                            <h2 class="text-sm font-semibold text-gray-700">Metallic</h2>
                            <div class="flex items-center gap-1 mt-1">
                                <input type="checkbox" id="exportMetallicMap" class="h-3 w-3 text-indigo-600 focus:ring-indigo-500 border-gray-500 rounded bg-gray-700" checked>
                                <label for="exportMetallicMap" class="text-xs">Export</label>
                            </div>
                            <div class="canvas-wrapper">
                                <canvas id="metallicMapCanvas" width="90" height="90"></canvas>
                            </div>
                        </div>
                        <div class="canvas-container" data-map-type="Displacement Map" data-source-canvas-id="displacementMapCanvas" data-explanation="Actually displaces the geometry vertices to create real height and depth. White is high, Black is low.">
                            <h2 class="text-sm font-semibold text-gray-700">Displacement</h2>
                            <div class="flex items-center gap-1 mt-1">
                                <input type="checkbox" id="exportDisplacementMap" class="h-3 w-3 text-indigo-600 focus:ring-indigo-500 border-gray-500 rounded bg-gray-700" checked>
                                <label for="exportDisplacementMap" class="text-xs">Export</label>
                            </div>
                            <div class="canvas-wrapper">
                                <canvas id="displacementMapCanvas" width="90" height="90"></canvas>
                            </div>
                        </div>
                        <div class="canvas-container" data-map-type="Emission Map" data-source-canvas-id="emissionMapCanvas" data-explanation="Defines the areas of the surface that emit light. White (1) is fully emissive, Black (0) is not emissive.">
                            <h2 class="text-sm font-semibold text-gray-700">Emission</h2>
                            <div class="flex items-center gap-1 mt-1">
                                <input type="checkbox" id="exportEmissionMap" class="h-3 w-3 text-indigo-600 focus:ring-indigo-500 border-gray-500 rounded bg-gray-700" checked>
                                <label for="exportEmissionMap" class="text-xs">Export</label>
                            </div>
                            <div class="canvas-wrapper">
                                <canvas id="emissionMapCanvas" width="90" height="90"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Controls for Animation Combiner Tab -->
                <div id="animation-combiner-controls" class="controls-group" style="display:none;">
                    <h3 class="text-sm font-semibold text-gray-700 mb-2">Animation Combiner</h3>
                    <p class="text-xs text-gray-500 mb-2">
                        Upload a character and one or more animations.
                    </p>
                    <div class="flex flex-col items-center gap-4 w-full">
                        <!-- Character Upload -->
                        <div class="w-full">
                            <label for="characterFbxInput" class="custom-file-upload w-full">
                                Upload Character FBX
                            </label>
                            <input type="file" id="characterFbxInput" accept=".fbx">
                            <span id="characterFileNameDisplay" class="text-xs text-center break-words w-full mt-1 block">No character file selected.</span>
                        </div>

                        <!-- Animations Upload -->
                        <div class="w-full">
                            <label for="animationFbxInput" class="custom-file-upload w-full">
                                Upload Animation(s) FBX
                            </label>
                            <input type="file" id="animationFbxInput" accept=".fbx" multiple>
                            <span id="animationFileNameDisplay" class="text-xs text-center break-words w-full mt-1 block">No animation files selected.</span>
                        </div>
                    </div>
                    <div class="controls-group mt-3">
                        <label for="animationSelect" class="text-xs font-medium">Select Animation:</label>
                        <select id="animationSelect">
                            <option value="">-- Load animations first --</option>
                        </select>
                    </div>
                    <div class="slider-group">
                        <label for="animationSpeedSlider">Speed: <span id="animationSpeedValue">1.00</span></label>
                        <input type="range" id="animationSpeedSlider" min="0.1" max="2.0" step="0.01" value="1.0">
                    </div>
                    <div class="flex items-center gap-1 mt-2">
                        <input type="checkbox" id="enableRootMotion" class="h-3.5 w-3.5 text-indigo-600 focus:ring-indigo-500 border-gray-500 rounded cursor-pointer bg-gray-700">
                        <label for="enableRootMotion" class="cursor-pointer select-none text-xs">Enable Root Motion</label>
                    </div>
                    <button id="loadAndPlayAnimationsButton" class="custom-file-upload mt-2">Load & Play</button>
                </div>

                <!-- Controls for Image to Mesh Tab -->
                <div id="image-to-mesh-controls" class="controls-group" style="display:none;">
                    <h3 class="text-sm font-semibold text-gray-700 mb-2">Image to Mesh</h3>
                    <p class="text-xs text-gray-500 mb-2">
                        Upload an image to convert it into a 3D mesh. Lighter areas will be higher.
                    </p>
                    <label id="meshDropZone" class="drop-zone">
                        <span class="text-sm text-gray-400 pointer-events-none">Drag & drop image or click to upload</span>
                        <input type="file" id="meshImageInput" accept="image/*">
                        <span id="meshFileNameDisplay" class="text-xs text-center break-words w-full mt-2 block">No image selected.</span>
                        <div id="meshLoadingSpinner" class="loader mx-auto"></div>
                    </label>
                    <div class="slider-group mt-3">
                        <label for="meshDetailSlider">Detail (Subdivisions): <span id="meshDetailValue">64</span></label>
                        <input type="range" id="meshDetailSlider" min="16" max="512" step="16" value="64">
                    </div>
                    <div class="slider-group mt-2">
                        <label for="meshHeightSlider">Height Scale: <span id="meshHeightValue">2</span></label>
                        <input type="range" id="meshHeightSlider" min="0" max="200" step="1" value="2">
                    </div>
                    <div class="flex items-center gap-1 mt-2">
                        <input type="checkbox" id="smoothMeshCheckbox" class="h-3.5 w-3.5 text-indigo-600 focus:ring-indigo-500 border-gray-500 rounded cursor-pointer bg-gray-700" checked>
                        <label for="smoothMeshCheckbox" class="cursor-pointer select-none text-xs">Smooth Mesh</label>
                    </div>
                    <div class="slider-group mt-2" id="meshSmoothingControls" style="display: flex;">
                        <label for="meshSmoothingIterationsSlider">Smoothing Iterations: <span id="meshSmoothingIterationsValue">2</span></label>
                        <input type="range" id="meshSmoothingIterationsSlider" min="1" max="10" step="1" value="2">
                    </div>
                    <!-- NEW: Mesh Preview Mode Selector -->
                    <div class="controls-group mt-2">
                        <label for="meshPreviewModeSelect" class="text-xs font-medium">Left Preview Mode:</label>
                        <select id="meshPreviewModeSelect">
                            <option value="depth">Depth Map (Black & White)</option>
                            <option value="normal">Normal Map (RGB Colors)</option>
                            <option value="wireframe" selected>Wireframe</option>
                        </select>
                    </div>
                    <button id="exportGlbButton" class="custom-file-upload mt-2">Export as .GLB</button>
                </div>
            </div>

            <!-- Center Panel: Main Content Area (Tabs for tools) -->
            <div class="main-content-area">
                <!-- Texture PBR Content -->
                <!-- This tab is a flex container. On desktop, it becomes a row to create a 3-column layout. -->
                <div id="texture-pbr-tab" class="tab-content active">
                    <!-- Middle Column: 3D Canvas Preview -->
                    <div class="canvas-wrapper flex justify-center items-center" style="flex: 1 1 0; min-width: 0; min-height: 100%; position: relative;">
                        <button id="resetPbrCameraBtn" class="reset-camera-button" title="Reset Camera">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 18px; height: 18px;"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0011.664 0l3.18-3.185m-3.181 9.348a8.25 8.25 0 00-11.664 0l-3.18 3.185m3.181-9.348L2.985 19.644" /></svg>
                        </button>
                        <canvas id="threeJsCanvas"></canvas>
                        <!-- Center Canvas Wrapper -->
                        <div class="absolute bottom-4 left-1/2 -translate-x-1/2 flex items-end space-x-2">
                            <div class="relative">
                                <button id="meshObjectsBtn" class="bg-white px-4 py-2 rounded-md shadow-md flex items-center space-x-2 text-sm text-gray-700 hover:bg-gray-100">
                                    <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                    <span>Mesh</span>
                                    <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </button>

                                <!-- Dropdown Menu (initially hidden, shown via JavaScript) -->
                                <div id="meshObjectsDropdown" class="absolute bottom-full mb-2 bg-white rounded-lg shadow-lg py-2 w-56 hidden">
                                    <button class="flex items-center space-x-2 px-4 py-2 text-sm text-gray-700 w-full text-left hover:bg-gray-100">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.523 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.523 18.246 18 16.5 18s-3.332.477-4.5 1.253"></path></svg>
                                    <span>Generate 3D Mesh</span>
                                    </button>
                                    <!-- <button class="flex items-center space-x-2 px-4 py-2 text-sm text-gray-700 w-full text-left hover:bg-gray-100">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L20 20M6 10a2 2 0 11-4 0 2 2 0 014 0zm2 0a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                                    <span>Add photos or videos</span>
                                    </button>
                                    <button class="flex items-center space-x-2 px-4 py-2 text-sm text-gray-700 w-full text-left hover:bg-gray-100">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                                    <span>Add files (docs, txt..)</span>
                                    </button> -->
                                </div>
                            </div>    
                    </div>
                </div>

                    <!-- Right Column: PBR Controls -->
                    <div class="right-side-controls-container" style="flex: 0 0 420px; height: 100%; overflow-y: auto; background-color: #f9fafb; border-radius: 0.6rem; padding: 1rem;">
                        <div class="controls-group">
                            <h3 class="text-sm font-semibold text-gray-700 mb-2">Color Palette</h3>
                            <div id="extractedColorPalette" class="color-palette w-full min-h-[70px]">
                                <!-- Color swatches will be inserted here -->
                                <p class="text-center w-full text-gray-500 text-sm">Upload an image to see its palette.</p>
                            </div>
                        </div>

                        <!-- Styles Section -->
                        <div class="controls-group">
                            <div class="flex items-center justify-between mb-3">
                              <h3 class="text-sm font-semibold text-gray-700">Styles</h3>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                              <div id="styleOriginalBtn" class="rounded-lg overflow-hidden border border-gray-300 cursor-pointer hover:border-blue-500" title="Revert to the original texture.">
                                <img id="styleOriginalPreviewImg" src="https://placehold.co/100x60/9CA3AF/D1D5DB?text=Original" alt="Original Texture Preview" class="w-full h-auto">
                              </div>
                              <div id="stylePixelateBtn" class="rounded-lg overflow-hidden border border-gray-300 cursor-pointer hover:border-blue-500 transition-all" title="Click to show pixelation settings.">
                                <img id="stylePixelatePreviewImg" src="https://placehold.co/100x60/60A5FA/E0F2FE?text=Pixelate" alt="Pixelate Style Preview" class="w-full h-auto">
                              </div>
                            </div>
                            <!-- Pixelate Settings Panel (Initially Hidden) -->
                            <div id="pixelateStyleSettings" class="hidden mt-3 p-3 border-t border-gray-200">
                                <h4 class="text-xs font-semibold text-gray-600 mb-2">Pixelate Settings</h4>
                                <div class="slider-group">
                                    <label for="stylePixelSizeSlider">Pixel Size: <span id="stylePixelSizeValue">8px</span></label>
                                    <input type="range" id="stylePixelSizeSlider" min="2" max="64" step="2" value="8">
                                </div>
                            </div>
                        </div>

                        <div class="controls-group" id="materialAdjustmentsControlsGroup">
                            <h3 class="text-sm font-semibold text-gray-700 mb-2">Material & Map Adjustments</h3>
                            
                            <div class="slider-group">
                                <label for="normalStrengthSlider">
                                    <span>Normal Strength: <span id="normalStrengthValue">1.00</span></span>
                                    <button class="reset-slider-button" data-slider-id="normalStrengthSlider" title="Reset to default">↺</button>
                                </label>
                                <input type="range" id="normalStrengthSlider" min="0.0" max="10.0" step="0.50" value="1.0">
                            </div>

                            <div class="slider-group">
                                <label for="roughnessIntensitySlider">
                                    <span>Roughness Intensity: <span id="roughnessIntensityValue">1.00</span></span>
                                    <button class="reset-slider-button" data-slider-id="roughnessIntensitySlider" title="Reset to default">↺</button>
                                </label>
                                <input type="range" id="roughnessIntensitySlider" min="0.0" max="2.0" step="0.01" value="1.0">
                            </div>

                            <div class="slider-group">
                                <label for="aoContrastSlider">
                                    <span>AO Contrast: <span id="aoContrastValue">1.00</span></span>
                                    <button class="reset-slider-button" data-slider-id="aoContrastSlider" title="Reset to default">↺</button>
                                </label>
                                <input type="range" id="aoContrastSlider" min="0.0" max="2.0" step="0.01" value="1.0">
                            </div>
                            <div class="slider-group">
                                <label for="aoIntensitySlider">
                                    <span>AO Intensity: <span id="aoIntensityValue">1.00</span></span>
                                    <button class="reset-slider-button" data-slider-id="aoIntensitySlider" title="Reset to default">↺</button>
                                </label>
                                <input type="range" id="aoIntensitySlider" min="0.0" max="1.0" step="0.01" value="1.0">
                            </div>

                            <div class="slider-group">
                                <label for="metallicSharpnessSlider">
                                    <span>Metallic Sharpness: <span id="metallicSharpnessValue">0.5</span></span>
                                    <button class="reset-slider-button" data-slider-id="metallicSharpnessSlider" title="Reset to default">↺</button>
                                </label>
                                <input type="range" id="metallicSharpnessSlider" min="0.0" max="1.0" step="0.01" value="0.5">
                            </div>

                            <div class="slider-group">
                                <label for="displacementDetailSlider">
                                    <span>Displacement Detail: <span id="displacementDetailValue">0.30</span></span>
                                    <button class="reset-slider-button" data-slider-id="displacementDetailSlider" title="Reset to default">↺</button>
                                </label>
                                <input type="range" id="displacementDetailSlider" min="0.0" max="2.0" step="0.01" value="0.30">
                            </div>
                            <div class="slider-group">
                                <label for="displacementScaleSlider">
                                    <span>Displacement Scale: <span id="displacementScaleValue">0.01</span></span>
                                    <button class="reset-slider-button" data-slider-id="displacementScaleSlider" title="Reset to default">↺</button>
                                </label>
                                <input type="range" id="displacementScaleSlider" min="0.0" max="1.0" step="0.01" value="0.01">
                            </div>
                            <div class="slider-group">
                                <label for="displacementBiasSlider">
                                    <span>Displacement Bias: <span id="displacementBiasValue">-0.02</span></span>
                                    <button class="reset-slider-button" data-slider-id="displacementBiasSlider" title="Reset to default">↺</button>
                                </label>
                                <input type="range" id="displacementBiasSlider" min="-0.5" max="0.5" step="0.01" value="-0.02">
                            </div>
                            <div class="slider-group">
                                <label for="emissionSlider">
                                    <span>Emission Threshold: <span id="emissionThresholdValue">220</span></span>
                                    <button class="reset-slider-button" data-slider-id="emissionSlider" title="Reset to default">↺</button>
                                </label>
                                <input type="range" id="emissionSlider" min="0" max="255" step="1" value="220">
                            </div>
                        </div>
                        <div class="controls-group">
                            <div class="slider-group">
                                <label for="sunAzimuthSlider">
                                    <span>Sun Azimuth: <span id="sunAzimuthValue">180</span>°</span>
                                    <button class="reset-slider-button" data-slider-id="sunAzimuthSlider" title="Reset to default">↺</button>
                                </label>
                                <input type="range" id="sunAzimuthSlider" min="0" max="360" step="1" value="180">
                            </div>
                            <div class="slider-group">
                                <label for="sunElevationSlider">
                                    <span>Sun Elevation: <span id="sunElevationValue">35</span>°</span>
                                    <button class="reset-slider-button" data-slider-id="sunElevationSlider" title="Reset to default">↺</button>
                                </label>
                                <input type="range" id="sunElevationSlider" min="0" max="90" step="1" value="35">
                            </div>
                            <div class="slider-group">
                                <label for="sunIntensitySlider">
                                    <span>Sun Intensity: <span id="sunIntensityValue">1.00</span></span>
                                    <button class="reset-slider-button" data-slider-id="sunIntensitySlider" title="Reset to default">↺</button>
                                </label>
                                <input type="range" id="sunIntensitySlider" min="0" max="5" step="0.01" value="1.0">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Animation Combiner Tab Content -->
                <div id="animation-combiner-tab" class="tab-content">
                    <h1 class="text-center mb-2 tracking-tight">
                        Animation Combiner
                    </h1>
                    <p class="text-center text-sm leading-tight max-w-xl mx-auto mb-3">
                        (Conceptual Feature) Blend multiple FBX animations for character models.
                    </p>

                    <div class="canvas-container" style="flex-grow: 1; min-height: 0;">
                        <h2 class="text-base">3D Animation Preview</h2>
                        <div id="animationCanvasWrapper" class="canvas-wrapper w-full flex-grow justify-center items-center">
                            <p id="animationPlaceholderText" class="text-center text-gray-500 text-sm p-4">Upload a character and animation files, then click "Load & Play".</p>
                            <canvas id="animationCombinerThreeJsCanvas" style="display:none; width: 100%; height: 100%;"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Image to Mesh Tab Content -->
                <div id="image-to-mesh-tab" class="tab-content">
                    <div class="relative">
                        <h1 class="text-center mb-2 tracking-tight">
                            Image to 3D Mesh Converter
                        </h1>
                        <p class="text-center text-sm leading-tight max-w-xl mx-auto mb-3">
                            Generate a 3D mesh from a 2D image's brightness values. Use the controls on the left to adjust the result.
                        </p>
                        <button id="resetMeshCameraBtn" class="reset-camera-button" title="Reset Camera" style="top: 0; left: 0;">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 18px; height: 18px;"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0011.664 0l3.18-3.185m-3.181 9.348a8.25 8.25 0 00-11.664 0l-3.18 3.185m3.181-9.348L2.985 19.644" /></svg>
                        </button>
                    </div>

                    <div id="mesh-previews-container" class="flex flex-col lg:flex-row gap-4" style="flex-grow: 1; min-height: 0;">
                        <!-- Left Preview: Depth/Geometry -->
                        <div class="canvas-container flex-1" style="min-width: 0;">
                            <h2 class="text-base">Depth Preview (Geometry)</h2>
                            <div id="meshDepthCanvasWrapper" class="canvas-wrapper w-full flex-grow justify-center items-center">
                                <p id="meshDepthPlaceholderText" class="text-center text-gray-500 text-sm p-4">Upload an image to generate a mesh.</p>
                                <canvas id="imageToMeshDepthCanvas" style="display:none; width: 100%; height: 100%;"></canvas>
                            </div>
                        </div>
                        <!-- Right Preview: Textured Mesh -->
                        <div class="canvas-container flex-1" style="min-width: 0;">
                            <h2 class="text-base">Textured Mesh Preview</h2>
                            <div id="meshCanvasWrapper" class="canvas-wrapper w-full flex-grow justify-center items-center">
                                <p id="meshPlaceholderText" class="text-center text-gray-500 text-sm p-4">Upload an image to generate a mesh.</p>
                                <canvas id="imageToMeshThreeJsCanvas" style="display:none; width: 100%; height: 100%;"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Image to Environment Texture Tab Content -->
                <div id="image-to-envmap-tab" class="tab-content">
                    <h1 class="text-center mb-2 tracking-tight">Image to Environment Texture</h1>
                    <p class="text-center text-sm leading-tight max-w-xl mx-auto mb-3">
                        Upload an image to use as the 3D scene's environment map (background and lighting).
                    </p>
                    <div class="controls-group">
                        <label id="envMapDropZone" class="drop-zone">
                            <span class="text-sm text-gray-400 pointer-events-none">Drag & drop image or click to upload</span>
                            <input type="file" id="envMapInput" accept="image/*">
                            <span id="envMapFileNameDisplay" class="text-xs text-center break-words w-full mt-2 block">No image selected.</span>
                            <div id="envMapLoadingSpinner" class="loader mx-auto"></div>
                        </label>
                        <button id="applyEnvMapButton" class="custom-file-upload mt-2">Apply as Environment</button>
                    </div>
                    <div class="canvas-container mt-4">
                        <h2 class="text-base">Preview</h2>
                        <div class="canvas-wrapper w-full flex justify-center items-center" style="height: 200px;">
                            <canvas id="envMapPreviewCanvas" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tooltip for Map Explanations -->
    <div id="mapTooltip" style="display: none;"></div>
</body>
</html>
